# Что из себя представляет ESP-32?
# Какие версии ESP-32 присутствуют на рынке?
# На чем можно писать для ESP-32?
# Как собирать код для ESP-32?




## Что из себя представляет ESP-32?

Это микроконтроллер со встроенным WIFI и Bluetooth.
Большими плюсами его явлется:
 - Цена - 3,5$ за микроконтроллер ESP32-WROOM с переходником на UART
 - Мощность за свою цену - 240 мГц - 2 ядра
 - Подробная и понятная документация
 - Большое комьюнити, которое готово помочь

Основным минусом является:
 - Закрытая прошивка

## Какую версии ESP-32 мы будем использовать?
Самую массовую ESP-32-WROOM с двумя ядрами 240мГц, SRAM 520КБ, ROM 448 КБ и FLASH 4 МБ. Её можно дешевле всего найти на Aliexpress. Чуть дороже будут варианты с 16 МБ FLASH
В другой версии - ESP-32-WROOVER имеется примерно такие же характеристики, но дополнительно установлена PSRAM, это SRAM, которая подключена вне чипа. Работает медленнее, но подходит для решения некоторых задач.
ESP выпущено множество версий, разные процессоры с разной архитектурой и частотой, разным кол-вом ядер, но я описал парочку самых популярных на Aliexpress.
Если это вашный первый микроконтроллер, то по мере использования будет приходить понимание характеристик и ограничений ESP-32. Просто покупайте WROOM версию и программируйте.

## На чем мы будем писать для ESP-32?

На Си с использованием фреймворка ESP-IDF, он подробно описан на оф. сайте Esspresif. Версия v5.4 stable.
Возможны и другие варианты, например MicroPython, интерпретируемый язык, который берет своей простотой, но скорость исполнения подходит не для всех задач.
Еще из популярный Arduino, но его так же не будем использовать из-за лишней траты ресурсов и слое абстракции, который может мешать работе, т.к. все равно под капотом используется esp-idf.
Таким образом мы пишем на фреймворке ESP-IDF.
Помимо знания Си требуется понимание FreeRTOS, системы реального времени.

Как и на чем собирать код? На Linux с помощью официальной утилиты esp-idf.py, которая умеет в создание/сборку/прошивку проектов, мониторинг и др. То есть мы будем из командной строки вызывать сборку.

Для редактирования кода я использую Vim с минимальными настройками.
Больше никаких инструментов не требуется.


## Как собирать код для ESP-32?
Вспомним, что я говорил в первом пункте? Покупаем ESP-32 с распаяным UART преобразователем. 
В ESP-32 есть загрузчик, которому можно подавать команды на запись, чтение и др.
В утилите esp-idf.py все это реализовано, нам нужно лишь пройти по гайду в котором мы клонируем репозиторий, устанавливаем зависимости, создаем проект hello-world, подключаем по USB к компьютеру нашу ESP-шку, запускаем idf.py firmware и idf.py monitor.
https://docs.espressif.com/projects/esp-idf/en/stable/esp32/get-started/linux-macos-setup.html

### А теперь разберем подробнее на примере Ubuntu:
Устанавливаем зависимости
`sudo apt-get install git wget flex bison gperf python3 python3-pip python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0` 

Создаем каталог и клонируем туда репозиторий с утилитами:
```
mkdir -p ~/esp
cd ~/esp
git clone -b v5.4 --recursive https://github.com/espressif/esp-idf.git
```
Это займет какое-то время, т.к. клонируем мы их рекурсивно, а сабмодулей много.

Теперь переходим к установке:

```
cd ~/esp/esp-idf
./install.sh esp32
```

Теперь перед всеми последующими вызовами `idf.py` нам нужен будет environment и мы будем к нему обращаться:
```
. ~/esp/esp-idf/export.sh
```
Для удобства создайте Alias и добавьте его в `~/.bashrc`: 
```
echo 'alias idf=". ~/esp/esp-idf/export.sh"' >> ~/.bashrc
```

Скопируем готовый проект hello world
```
cd ~/esp
cp -r $IDF_PATH/examples/get-started/hello_world .
```

Переходим в каталог и выбираем esp32
```
cd ~/esp/hello_world
idf.py set-target esp32
idf.py menuconfig
```
В menuconfig можно настроить множество параметров, нас сейчас интересует только Serial Flasher Config -> Flash Size. Выбираем 4 МБ.

Теперь подключаем к компьютеру и наблюдаем новое устройство в /dev/
`ls /dev/ttyU*`
Результатом должен быть `/dev/ttyUSB0`, если это не так, то посмотрите как наименовался ваш девай и запомните это.
Возможно он будет неправильно определяться, это можно увидеть выполнив `dmesg -T`
Одним из решений будет изменение правил в `/etc/udev/rules.d`
Понять, что в этом проблема можно с помощью `watch -n 0.1 ls /dev/ttyU*`
Если при подключении ESP-32 появляется на секунду девай и исчезает, то это точно проблема с `rules.d`

После того как Вы разобрались с подключением ESP-32, переходим к прошивке.
```
idf.py flash monitor
```
Можно выполнять несколько команд в одну строку перечисляя их. flash вызовет build, прошьет esp и будет читать вывод с `/dev/ttyUSB0`.
Если в выводе мы увидим повторяющийся hello-world и рестарт, то это успех :-) 

Все дальнейшее программирование будет проще: Переходим в каталог с проектом, дергаем alias idf. правим код, прошиваем, idf.py flash и радуемся результату.
